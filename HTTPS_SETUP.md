# HTTPS Setup Guide

This guide explains how to set up HTTPS access for the Cadastro Unificado API.

## üöÄ Quick Setup

### 1. Generate SSL Certificates

**Windows (PowerShell):**

```powershell
.\scripts\generate-ssl.ps1
```

**Linux/Mac:**

```bash
./scripts/generate-ssl.sh
```

### 2. Restart Services

```bash
docker compose down
docker compose up -d
```

### 3. Test HTTPS Access

- **HTTPS Proxy**: https://10.13.65.37:8443
- **Health Check**: https://10.13.65.37:8443/nginx-health
- **API**: https://10.13.65.37:8443/api/v1/health/

## üìä Service URLs

| Service         | HTTP URL                | HTTPS URL                | Description       |
| --------------- | ----------------------- | ------------------------ | ----------------- |
| **Nginx Proxy** | http://10.13.65.37:8081 | https://10.13.65.37:8443 | Main access point |
| **Backend API** | http://10.13.65.37:8001 | ‚ùå Not available         | Internal only     |

## üîß Configuration Changes Made

### 1. Environment Variables Updated

```yaml
# HTTPS URLs
CORS_ALLOWED_ORIGINS=https://10.13.65.37:8443,https://10.13.65.37:8001,https://10.13.65.37:3000

# SSL Settings
SECURE_SSL_REDIRECT=True
SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
USE_TLS=True
```

### 2. Nginx Configuration

- **HTTP (8081)**: Redirects to HTTPS
- **HTTPS (8443)**: Main server with SSL
- **SSL Certificates**: `/etc/nginx/ssl/nginx.crt` and `/etc/nginx/ssl/nginx.key`

### 3. Port Configuration

```yaml
nginx:
  ports:
    - "8081:80" # HTTP (redirects to HTTPS)
    - "8443:443" # HTTPS (main access)
```

## üîç Testing HTTPS Access

### Manual Testing

```bash
# Test HTTPS health check
curl -k https://10.13.65.37:8443/nginx-health

# Test HTTPS API
curl -k https://10.13.65.37:8443/api/v1/health/

# Test HTTP redirect
curl -I http://10.13.65.37:8081/
# Should return: 301 Moved Permanently
```

### Browser Testing

1. **HTTPS Access**: https://10.13.65.37:8443
2. **HTTP Redirect**: http://10.13.65.37:8081 (should redirect to HTTPS)

## ‚ö†Ô∏è Important Notes

### 1. Self-Signed Certificates

The generated certificates are **self-signed** for development/testing:

- Browser will show security warning
- Use `-k` flag with curl to ignore certificate warnings
- For production, use certificates from a trusted CA

### 2. Backend Direct Access

**‚ùå Don't access**: `https://10.13.65.37:8001/`

- Backend is HTTP-only internally
- Only accessible through nginx proxy

**‚úÖ Correct access**: `https://10.13.65.37:8443/`

- Goes through nginx with SSL termination
- Properly configured for HTTPS

### 3. Certificate Management

**Development:**

- Self-signed certificates in `ssl/` directory
- Generated by the provided scripts

**Production:**

- Use certificates from trusted CA (Let's Encrypt, etc.)
- Replace `ssl/nginx.crt` and `ssl/nginx.key`
- Ensure proper file permissions (600 for key, 644 for cert)

## üêõ Troubleshooting

### 1. Certificate Issues

```bash
# Check certificate validity
openssl x509 -in ssl/nginx.crt -text -noout

# Test nginx configuration
docker exec cadastro_nginx nginx -t
```

### 2. Connection Refused

```bash
# Check if containers are running
docker compose ps

# Check nginx logs
docker compose logs nginx

# Check if ports are listening
netstat -tlnp | grep :8443
```

### 3. SSL Handshake Errors

- Verify certificates exist in `ssl/` directory
- Check file permissions
- Ensure nginx configuration is correct

### 4. Browser Security Warnings

This is normal for self-signed certificates:

- Click "Advanced" ‚Üí "Proceed to site"
- Or add certificate to browser's trusted store

## üîÑ Migration from HTTP to HTTPS

### Before (HTTP only):

- Backend: http://10.13.65.37:8001
- Nginx: http://10.13.65.37:8081

### After (HTTPS):

- Backend: ‚ùå Not directly accessible
- Nginx HTTP: http://10.13.65.37:8081 (redirects to HTTPS)
- Nginx HTTPS: https://10.13.65.37:8443 ‚úÖ

## üìù Development Workflow

1. **Generate certificates**: `.\scripts\generate-ssl.ps1`
2. **Start services**: `docker compose up -d`
3. **Test access**: https://10.13.65.37:8443
4. **Monitor logs**: `docker compose logs -f nginx`

## üõ°Ô∏è Security Considerations

### Development:

- Self-signed certificates acceptable
- HTTP redirects to HTTPS
- Basic SSL configuration

### Production:

- Use trusted CA certificates
- Enable HSTS headers
- Configure proper SSL ciphers
- Regular certificate renewal
